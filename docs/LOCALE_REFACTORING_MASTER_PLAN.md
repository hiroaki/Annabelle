# ロケールシステム リファクタリング マスタープラン

## ドキュメント概要

このドキュメントは、Railsアプリケーションのロケールシステム全体のリファクタリングを管理するマスタープランです。複数のAIセッション間で一貫した作業を進めるため、現状、計画、進捗、注意事項をまとめています。

**⚠️ 重要**: 新しいAIセッションを開始する際は、このドキュメントを必ず参照してください。

## 現在の状況（2025年6月12日時点）

### プロジェクト状態
- **フェーズ**: 分析・計画完了、実装前
- **現在のコード**: 改修前の状態（問題を含む）
- **ドキュメント**: 分析・戦略立案完了

### 関連ドキュメント
1. **LOCALE_SYSTEM.md** - 改修前の現在のシステム分析（参考用）
2. **LOCALE_SYSTEM_REFACTORING_PLAN.md** - 詳細な問題分析と改善戦略
3. **LOCALE_SYSTEM_REFACTORING_EXECUTION_PLAN.md** - 6ステップの実行計画
4. **OAUTH_LOCALE_STRATEGY.md** - OAuth認証時の言語引き継ぎ戦略

## 特定された主要問題

### 1. オプショナルロケール処理の問題
- **現状**: URLにロケールがない場合の曖昧な処理
- **影響**: 一貫性のないURL構造、ユーザー体験の悪化
- **解決策**: 明示的ロケール必須化

### 2. 混在するURL戦略
- **現状**: パスベース（/ja/users）とクエリパラメータ（?locale=ja）の混在
- **影響**: 複雑な条件分岐、保守困難
- **解決策**: パスベースURL戦略への統一

### 3. ハードコード化された設定
- **現状**: 利用可能ロケールがコード内に直接記述
- **影響**: 設定変更時の複数箇所修正
- **解決策**: 外部設定ファイル化とキャッシュ

### 4. 複雑な条件分岐
- **現状**: LocaleServiceの複雑なif-else構造
- **影響**: バグの温床、テスト困難
- **解決策**: ロジック簡素化と優先順位明確化

### 5. テスト/プロダクション環境の不整合
- **現状**: 環境によって異なるロケール決定ロジック
- **影響**: デバッグとテストが困難
- **解決策**: 統一されたロジック

### 6. OAuth認証時の言語引き継ぎ
- **現状**: 基本実装済みだが改善の余地あり
- **特殊事情**: コールバックURLにロケール含められない
- **解決策**: セッションフォールバック追加、フォールバック戦略強化

## 6段階実行計画

### ✅ ステップ1: 設定の外部化とキャッシュ機能の追加
- **状態**: ✅ 完了 (2025年6月12日)
- **対応問題**: ハードコード化された設定
- **作業内容**:
  - [x] `config/locales.yml`作成
  - [x] `LocaleConfiguration`クラス実装
  - [x] 既存コードの移行
- **影響ファイル**: 新規作成2件、修正3件
- **実装詳細**: 
  - シングルトンパターンでキャッシュ機能実装
  - TTL設定可能（デフォルト1時間）
  - LocaleValidator、LocaleService、LocaleHelper全て対応済み
  - 全テストケース通過確認済み

### ✅ ステップ2: URL戦略変更の準備
- **状態**: ✅ 完了 (2025年6月12日)
- **対応問題**: 混在するURL戦略
- **作業内容**:
  - [x] `LocaleUrlHelper`作成
  - [x] ヘルパーメソッド統一
  - [x] テンプレート使用箇所確認・更新
  - [x] フィーチャーフラグ実装
- **影響ファイル**: 新規作成2件、修正2件
- **実装詳細**:
  - パスベース/クエリパラメータ両方式に対応
  - フィーチャーフラグによる段階的移行準備
  - 言語切り替えUI統一
  - 全テストケース通過確認済み

### ✅ ステップ3: ルーティング構造の修正（明示的ロケール必須化）
- **状態**: ✅ 完了 (2025年6月12日)
- **対応問題**: オプショナルロケール処理の問題
- **特別考慮**: OAuth認証コールバックは例外扱い
- **作業内容**:
  - [x] `config/routes.rb`修正（ロケール必須化）
  - [x] ルートパスリダイレクト処理追加
  - [x] OAuth特例処理の実装
  - [x] LocaleRedirectController作成
- **影響ファイル**: 修正2件、新規作成2件
- **実装詳細**:
  - ルートパス (/) から適切なロケール付きURLへの自動リダイレクト
  - OAuth認証は明示的ロケール必須化の例外として処理
  - クエリパラメータ保持機能付きリダイレクト
  - パスベースロケール有効化設定追加
  - 全テストケース（request spec）通過確認済み

### ✅ ステップ4: LocaleServiceロジックの簡素化
- **状態**: ✅ 完了 (2025年6月13日)
- **対応問題**: 複雑な条件分岐、環境間不整合
- **作業内容**:
  - [x] 条件分岐の簡素化（langパラメータ処理削除）
  - [x] 環境統一ロジック実装（フォールバック戦略明確化）
  - [x] 優先順位明確化（明示的ロケール → URLロケール → フォールバック）
  - [x] SessionsController対応（langからlocaleパラメータに変更）
- **影響ファイル**: 修正4件（LocaleService、テスト、SessionsController、テスト）
- **実装詳細**:
  - `determine_effective_locale`の簡素化（6段階→3段階）
  - 新しい`determine_fallback_locale`メソッド追加
  - `redirect_path_for_user`のフォールバック戦略統一
  - SessionsControllerのlang→locale移行
  - 全テストケース通過確認済み

### ⏳ ステップ5: UI/UX一貫性の改善 + OAuth改善
- **状態**: 🔴 未実装
- **対応問題**: 混在するURL戦略、OAuth言語引き継ぎ
- **作業内容**:
  - [ ] 言語切り替えUI改善
  - [ ] URL構造統一
  - [ ] **OAuth戦略実装**（OAUTH_LOCALE_STRATEGY.mdに基づく）
    - [ ] セッションフォールバック追加
    - [ ] フォールバック戦略強化
    - [ ] ログ出力改善
- **影響ファイル**: 修正3件以上
- **所要時間**: 2-3日

### ⏳ ステップ6: クリーンアップと最適化
- **状態**: 🔴 未実装
- **対応問題**: 全般的なコード品質
- **作業内容**:
  - [ ] 不要コード削除
  - [ ] パフォーマンス最適化
  - [ ] ドキュメント更新
  - [ ] テストカバレッジ改善
- **影響ファイル**: 全体的なクリーンアップ
- **所要時間**: 1日

## OAuth認証の特別扱い

### 重要な考慮事項
OAuth認証は**固定コールバックURL**のため、明示的ロケール必須化の**例外**として扱う必要があります。

### 統合戦略
- **ステップ3**でOAuth例外処理を実装
- **ステップ5**で`OAUTH_LOCALE_STRATEGY.md`の内容を実装
- セッションベースフォールバック、複数ソース対応を追加

## 新しいAIセッション開始時のチェックリスト

### 🔍 事前確認項目
1. [ ] このマスタープランを読んで現状把握
2. [ ] 現在のステップ状態を確認
3. [ ] 作業対象ファイルの現在の状態を確認
4. [ ] 関連する他のステップとの依存関係を確認

### 📋 セッション開始時の質問例
- "現在どのステップを実装中ですか？"
- "前回のセッションで何が完了しましたか？"
- "OAuth認証の特別扱いについて理解していますか？"

### 🚨 重要な注意事項
1. **段階的実装**: 各ステップを順番に実行し、テスト後に次へ進む
2. **OAuth特例**: ステップ3とステップ5でOAuth認証の特別処理を実装
3. **バックアップ**: 各ステップ前にGitコミット作成
4. **テスト**: 各ステップ後に動作確認必須

## 進捗管理

### 完了したステップ
- ✅ 分析フェーズ（問題特定、戦略立案）
- ✅ ドキュメント作成（計画書、戦略書）
- ✅ **ステップ1**: 設定の外部化とキャッシュ機能の追加（2025年6月12日完了）
- ✅ **ステップ2**: URL戦略変更の準備（2025年6月12日完了）
- ✅ **ステップ3**: ルーティング構造の修正（明示的ロケール必須化）（2025年6月12日完了）
- ✅ **ステップ4**: LocaleServiceロジックの簡素化（2025年6月13日完了）

### 現在のステップ
- 🔄 **ステップ5実装待ち**: UI/UX一貫性の改善 + OAuth改善

### 次回セッションの推奨開始点
**ステップ5から開始**: UI/UX一貫性の改善 + OAuth改善

## 検証基準

### 各ステップの成功基準
1. **ステップ1**: 設定が外部ファイルから読み込まれ、キャッシュが機能する
2. **ステップ2**: URL生成ロジックが統一される
3. **ステップ3**: すべてのURLでロケールが必須となり、OAuthが正常動作する
4. **ステップ4**: ロケール決定ロジックが単純化される
5. **ステップ5**: UI/UXが一貫し、OAuth言語引き継ぎが確実になる
6. **ステップ6**: コードが最適化され、ドキュメントが更新される

### 最終目標
- 🎯 一貫したURL構造（パスベースのみ）
- 🎯 明示的ロケール必須（OAuth例外あり）
- 🎯 簡素化されたロケール決定ロジック
- 🎯 外部化された設定管理
- 🎯 確実なOAuth言語引き継ぎ
- 🎯 改善されたユーザー体験

## リソース

### 参照ドキュメント
- `LOCALE_SYSTEM.md`: 現在のシステム分析
- `LOCALE_SYSTEM_REFACTORING_PLAN.md`: 詳細分析と戦略
- `LOCALE_SYSTEM_REFACTORING_EXECUTION_PLAN.md`: 実行手順
- `OAUTH_LOCALE_STRATEGY.md`: OAuth特別戦略

### 重要なファイル群
```
app/services/locale_service.rb          # 主要ビジネスロジック
app/helpers/locale_helper.rb            # ユーティリティ関数  
app/controllers/application_controller.rb # ベースコントローラー
app/controllers/users/omniauth_callbacks_controller.rb # OAuth処理
config/routes.rb                        # ルーティング設定
app/views/devise/shared/_links.html.erb # OAuth開始UI
```

---

**📌 このドキュメントを更新**: 作業進捗に応じて、各ステップの状態（🔴→🔄→✅）を更新してください。

**🤝 AIセッション引き継ぎ**: 新しいセッションでは「リファクタリング作業の続きをお願いします。マスタープランを確認して現在の状況を教えてください」と伝えてください。
