# ロケールシステム改善計画 (Locale System Improvement Plan)

ロケールシステムのレビューに基づき、以下の単位ごとに改修を進めるための計画を示します。各AIセッションでこの情報を共有することで、一貫した改善を行うことができます。

## 改修単位1: OAuthLocaleServiceの分離 --> 完了

<!-- ### 現状の問題
- `OAuthLocaleService`がコントローラー内に定義されており、コード再利用性とテスタビリティが低下
- `app/controllers/users/omniauth_callbacks_controller.rb`内にクラスが埋め込まれている

### 改修方針
1. `OAuthLocaleService`を独立した`app/services/oauth_locale_service.rb`ファイルに移動
2. 関連するテストを更新/追加
3. コントローラーでは新しいファイルを参照するよう変更

### 改修ステップ
1. 新ファイル`app/services/oauth_locale_service.rb`を作成
2. 既存の実装をコントローラーから新ファイルに移動（依存関係に注意）
3. コントローラーを更新して新しいクラスを使用
4. テストを更新して新しい構造を反映 -->

## 改修単位2: ヘルパーモジュールの実装スタイル統一 --> 完了

<!-- ### 現状の問題
- `LocaleHelper`と`LocaleUrlHelper`でモジュール関数と、他クラスでの静的メソッドなど実装スタイルが混在
- 呼び出し側でのスタイルも統一されていない

### 改修方針
1. ヘルパーの実装スタイルを統一する
2. 呼び出し側でのスタイルも統一する

### 改修ステップ
1. モジュール関数（`module_function`）を使用する場合は一貫して使用
2. インスタンスメソッドとして使用する場合はincludeの仕方を統一
3. 混合パターンを避け、明確なAPIを定義
4. テストを更新して新しい呼び出し方法を確認 -->

## 改修単位3: LocaleConfigurationのAPI整理 --> 完了

<!-- ### 現状の問題
- `LocaleConfiguration.instance`の直接呼び出しとクラスメソッド経由の呼び出しが混在
- キャッシュ無効化の仕組みがない

### 改修方針
1. 一貫してクラスメソッド経由でのみ利用するよう統一
2. 明示的なキャッシュ無効化メソッドを追加
3. 開発環境での自動最適化を実装

### 改修ステップ
1. インスタンスへの直接アクセスを非推奨化
2. すべての呼び出しをクラスメソッド経由に移行
3. `clear_cache!`メソッドを追加
4. 環境ごとの設定最適化を実装
5. テストを更新 -->

検討の結果、当初の改修方針から以下の点について実装方針を変更した。
運用・保守性とシンプルさを重視し、最小限の責務に徹した実装へと整理した。

- 明示的なキャッシュ無効化メソッド（例：clear_cache!）の追加は行わず、そもそもキャッシュ自体を廃止し、常にYAMLを一度だけ読み込むシンプルな構成とした。
- 開発環境での自動最適化や環境ごとの設定最適化（例：TTLや自動リロード等）は実装せず、全環境で同一の挙動とした。
- 設定値の変更やリロードを前提としたAPIやメソッド（例：キャッシュクリアやリロード系）は一切提供しない設計とした。
- 必要なバリデーションは初期化時にのみ行い、以降は設定ファイルの内容をそのまま利用する。
- 設定ファイル（locales.yml）が存在しない場合や必須キーが不正な場合は即時例外を発生させる。

## 改修単位4: パスベース戦略完全移行 --> 完了

<!-- ### 現状の問題
- `use_path_based_locale?`などの条件分岐が残存
- クエリパラメータサポートが混在している

### 改修方針
1. リファクタリング計画に基づき、完全にパスベース戦略に移行
2. 条件分岐とフラグを削除
3. 古いコードパスを削除

### 改修ステップ
1. `use_path_based_locale?`の使用箇所を特定
2. コードをパスベース戦略のみに簡略化
3. 不要になった条件分岐とメソッドを削除
4. テストを更新して新しい動作を確認 -->

## 改修単位5: エラー処理の統一 --> 完了

<!-- ### 現状の問題
- ロケール関連エラーの処理が一貫していない
- エラーログとユーザー向けメッセージの整合性が取れていない

### 改修方針
1. ロケールエラーの包括的な捕捉と処理を実装
2. ログ出力レベルと内容を統一
3. ユーザー向けエラーメッセージを改善

### 改修ステップ
1. エラーケースを網羅的に特定
2. 共通のエラー処理メカニズムを実装
3. ログ出力を標準化
4. ユーザー向けメッセージを改善
5. テストでエラーケースをカバー -->

翻訳のエラーはユーザに見せても、ユーザは何もアクションを取ることもないため、エラーログを出すのみにします。

## 改修単位6: OAuthからのリダイレクト処理の整理 --> 完了

<!-- ### 現状の問題
- OAuthコールバック後のリダイレクトパス決定ロジックが複数の場所に分散
- 条件分岐が複雑で追いにくい

### 改修方針
1. リダイレクトパス決定ロジックを統合
2. 条件分岐を簡素化
3. 一貫した優先順位を持つロジックに整理

### 改修ステップ
1. リダイレクト処理の現状分析と整理
2. 共通のリダイレクトロジックを実装
3. コントローラーの更新
4. テストケースの追加と更新 -->

## 改修単位7: ドキュメント更新

### 現状の問題
- ドキュメントと実装の間に乖離がある
- `LOCALE_SYSTEM_CURRENT.md`が最新の実装を正確に反映していない

### 改修方針
1. 実装を正確に反映した最新のドキュメントを作成
2. コード内コメントを充実させる
3. APIドキュメントを整備

### 改修ステップ
1. 現在の実装を詳細に分析
2. `LOCALE_SYSTEM_CURRENT.md`を更新
3. コード内のコメントを改善
4. 必要に応じて追加ドキュメントを作成

---

## 重要な注意事項

1. **プランと実装の乖離**: `LOCALE_SERVICE_REFACTORING_PLAN.md`はあくまでプランであり、実際の実装ではハッシュ形式を採用するなど、変更点があります。プランと実装の違いは開発過程での自然な変化として理解すべきです。

2. **互換性の維持**: 改修によって既存の機能を破壊しないよう注意してください。特にAPIの変更は呼び出し側のコードも更新する必要があります。

3. **段階的な改修**: 各改修単位は独立して進めることができますが、依存関係に注意してください。各単位の改修後は必ずテストを実行し、既存の機能が正常に動作することを確認してください。

4. **テストの重要性**: すべての改修には適切なテストケースを追加し、既存のテストが通過することを確認してください。テストカバレッジを維持または向上させることが重要です。

5. **ドキュメントの更新**: コードの変更に合わせて、ドキュメントも更新してください。特にAPIの変更や新機能の追加時は重要です。
