# デプロイ

デプロイ環境は利用者によって様々に異なるため、汎用的で明確な手順を作成することができません。ただしプロジェクトには、デプロイツールとして Kamal が（ Bundler によって）インストールされており、デプロイは Kamal を使用することができます。

## Dockerfile の利用

プロジェクトのトップディレクトリにある Dockerfile は、ステージング環境およびプロダクション環境のためのものです。これを用いてデプロイ用の Docker イメージを作成することができます。ただしこれは、以下の「Kamal でステージング環境を構築する」の「構成」で述べている環境を前提として設計されていますので、それとは異なるニーズが要求される部分については適宜カスタマイズしてください。

また注意事項として、この Dockerfile のビルドには `--build-arg` の引数に `RAILS_ENV` が必須となっており、これに "staging" または "production" をセットしてビルドする必要があります。この引数の `RAILS_ENV` はあくまで引数の名称であり、ユーザの環境変数に `RAILS_ENV` （これは環境変数の変数名）が設定されていても、それが暗黙のうちに使われるわけではありません。もちろん環境変数を参照させて `--build-arg RAILS_ENV=$RAILS_ENV` という書き方もできますが、事故を未然に防ぐために文字列で指定してください、次のように：

```
# 本番環境
$ docker build --build-arg RAILS_ENV=production -t annabelle-production:latest .
```

```
# ステージング環境
$ docker build --build-arg RAILS_ENV=staging -t annabelle-staging:latest .
```

## Kamal でステージング環境を構築する

Kamal によるステージング環境へのデプロイ手順の一例を紹介します。

### 構成

これから紹介する例では、次のような構成を前提とします。

```
                   User (developer)
......................................................
   |        |                                     |
   |        | access                              |
   |        v                                     |
   |        443                                   |
   |    +-----------+                             |
   |    |kamal-proxy|                             |
   |    +-----------+                             |
   |        |                                     | access
   |        |forward                              |
   |        v                                     v
   |       3001                                  1080
   |   +----------------+                    +-----------+
   |   |thruster + Rails|---["kamal"]--> 1025|MailCatcher|
   |   +----------------+    Network         +-----------+
   |        ^                                     ^
   |        | pull                                | pull    LAN
~~~|~~~~~~~~|~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|~~~~~~~~~~~~~~~~~
   v push   |                                     |         Internet
 +------------------------+               +--------------+
 |    Container Registry  |               | Docker Hub   |
 +------------------------+               +--------------+
```

- User はステージング環境をテストする開発者を表します。ここからデプロイ、およびサービスの利用を行います。
- kamal-proxy をエントリーポイントとし、また SSL終端 として位置付けます。ポート番号は 443 とします。
- アプリケーションサーバは puma のラッパーとなる thruster を利用します。ポート番号は 3001 とします。
- Rails からのメールを処理する SMTP サーバーには MailCatcher を利用し、その間の通信は Docker の内部ネットワーク "kamal" を利用します。
- MailCatcher の Web インターフェースは、 Proxy を通さずに、そのまま 1080番 ポートで公開します。
- 各役割のサーバーについて、ステージング環境ではすべて同じホストにデプロイします。上の図では別々に描かれていますが、実際は一つのホスト内にあります。

  ```
    proxy.ssl.host = servers.web.host = accessories.host
    +----------------------------------------------------+
    | +-----------+   +----------------+   +-----------+ |
    | |kamal-proxy|   |thruster + Rails|   |MailCatcher| |
    | +-----------+   +----------------+   +-----------+ |
    +----------------------------------------------------+
  ```

### デプロイ先の Docker

この例では、デプロイ先サーバーでは Docker エンジンがすでに稼働している状態を前提としてます。

Kamal には Docker 自体を自動でインストールする機能もありますが、それを利用するにはデプロイ先へログインする SSH ユーザとして `root` を設定しなければならなくなり、その後も継続して root ユーザでのアセクスが必要になってしまいます。今回の例では、デプロイ先へ SSH 接続するユーザは、この例の設定としては環境変数 `DEPLOY_SSH_USER` に設定するユーザです。これは一般ユーザを想定しています。

一般ユーザが Docker コンテナを作成するには、そのユーザーがグループ `docker` に属している必要がありますので、その状況を確認してください。まだグループに属していなければ、次のようにして参加させることができます：

```sh
$ sudo usermod -aG docker <ユーザー名>
```

Docker エンジンがまだインストールされていない場合は、次のようにインストールできます。なお Docker の Rootless モードは未検証ですので、インストールそのものは特権ユーザで行ってください：

```sh
# Rocky Linux 9 の例
$ sudo dnf install -y dnf-plugins-core
$ sudo dnf config-manager --add-repo=https://download.docker.com/linux/centos/docker-ce.repo
$ sudo dnf install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
$ sudo systemctl enable --now docker
```

### config/deploy.yml ファイル

Kamal の設定ファイルである `config/deploy.yml` にはただ一つの記述 `require_destination: true` という設定だけがあります。これはデプロイ先に応じた別の設定ファイルの存在を暗示しており、実行時にはそのデプロイ先を指定する必要があることを設定しています。

デプロイ先がステージング環境用のものは、サンプルとしてファイル `config/deploy.staging.yml.sample` が用意されていますので、これを `config/deploy.staging.yml` という名のファイルに複製し、これをカスタムしてください。

いま説明している例の構成においては、何も変更する箇所はありません。変更するべきすべての値は環境変数から読み取るようになっています。設定する必要がある環境変数については後述します。

### .kamal/secrets ファイル

ファイル `config/deploy.staging.yml` の記述の中で秘匿情報にあたる部分は、別管理のファイル `.kamal/secrets` があります。そしてこれもまた、 Kamal のデプロイ先に応じた別のファイルがあります。この例ではステージング環境であるので、ここでは `.kamal/secrets.staging` がその扱うべき対象のファイルとなります。

前項で述べた設定ファイル `config/deploy.staging.yml` を変更していないのであれば、 `.kamal/secrets.staging` についても修正箇所はありません。変更するべきすべての値は、環境変数から読み取るようになっています。

### コンテナ・レジストリ

Kamal のコンセプトにより、デプロイ元でビルドされたイメージは、コンテナー・レジストリへ push されることになります。

このレジストリはインターネット上のサービスになります（ Docker や GitHub など）。そのためにそれらのサービスにコンテナを push するためのアカウント（アクセス権）が必要です。

### SSL (TSL) 証明書と hosts ファイル

SSL(TSL) のサーバー証明書については、 Kamal では Let's Encrypt （外部サービス）を利用した証明書の作成（更新）を自動で行う機能がありますが、この例では LAN 内に構築するステージング環境という都合から、 mkcert を利用した自前のルート認証局をあらかじめ作成し、そのルート証明書を User の環境およびデプロイ先の環境にインストールしておくことになります。

またその際、 Common Name となるホスト名が解決できなければいけないため、 `/etc/hosts` ファイルにホスト名を登録しておきます（もし LAN 内のアドレスを解決できる DNS が利用できるのであれば、それで十分です）

### 環境変数の設定

アプリケーション設定や、デプロイ設定のために必要な、環境変数を設定します。設定項目についてはファイル `dot.env.staging.skel` の内容に記載されているものです。 dotenv を利用する場合は `dot.env.staging.skel` を `.env.staging` という名で複製し、その `.env.staging` 内に記載されている変数に、実際に利用する値を与えて更新してください。

### デプロイの実行

シェルに環境変数をセットしたのち、次のコマンドでデプロイします。

```
$ bundle exec kamal deploy --destination=staging
```

dotenv を使って環境変数を設定しながら実行する場合は、ファイル `.env.staging` を指定しながら実行します：

```
$ dotenv -f .env.staging bundle exec kamal deploy --destination=staging
```

### その他（注意点など）

- コンテナのビルドではカレント・ディレクトリが COPY されるので、 git 管理外のファイルが混じっていてもそれらはイメージに含まれます。秘匿情報が入り込まないように注意してください。
- カレント・ディレクトリが git 管理下にないと、デプロイできません。（ deploy 時に --version="..." を指定すればよいかもしれません？）
