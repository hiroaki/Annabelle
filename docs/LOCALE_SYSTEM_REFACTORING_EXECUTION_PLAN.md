# ロケールシステム リファクタリング実行計画

## 概要

このドキュメントは、Railsアプリケーションのロケールシステムの問題点を解決するための具体的な実行計画です。現在のシステムには以下の主要な懸念点があり、これらを段階的に改善していきます。

## 特定された主要な懸念点

1. **オプショナルロケール処理の問題**
   - URLにロケールがない場合の曖昧な処理
   - デフォルトロケールの決定ロジックが複雑
   - 一貫性のないURL構造

2. **混在するURL戦略**
   - パスベース（`/ja/users`）とクエリパラメータ（`?locale=ja`）の混在
   - 戦略の使い分けが複雑で一貫性がない

3. **ハードコード化された設定**
   - 利用可能ロケールがコード内に直接記述
   - 設定変更時に複数箇所の修正が必要

4. **複雑な条件分岐**
   - LocaleServiceの複雑なif-else構造
   - テスト環境とプロダクション環境での異なる動作

5. **テスト/プロダクション環境の不整合**
   - 環境によって異なるロケール決定ロジック
   - デバッグとテストが困難

## 6段階の改善計画

### ステップ1: 設定の外部化とキャッシュ機能の追加

**対応する懸念点**: ハードコード化された設定

**目的**: 設定を外部化し、パフォーマンスを向上させる

**作業内容**:
1. `config/locales.yml`を作成し、利用可能ロケールを外部化
2. `LocaleConfiguration`クラスを作成し、設定とキャッシュを管理
3. 既存コードを新しい設定システムに移行

**ファイル変更**:
- 新規作成: `config/locales.yml`
- 新規作成: `app/lib/locale_configuration.rb`
- 修正: `app/services/locale_service.rb`
- 修正: `app/helpers/locale_helper.rb`

**検証方法**:
- 設定ファイルからロケール一覧が正しく読み込まれること
- キャッシュが機能していること
- 既存の機能が正常に動作すること

### ステップ2: URL戦略変更の準備

**対応する懸念点**: 混在するURL戦略

**目的**: パスベースURL戦略への統一準備

**作業内容**:
1. `LocaleUrlHelper`を作成し、URL生成ロジックを統一
2. 既存のヘルパーメソッドを新しいヘルパーに移行
3. テンプレートやビューファイルでの使用箇所を確認

**ファイル変更**:
- 新規作成: `app/helpers/locale_url_helper.rb`
- 修正: `app/helpers/locale_helper.rb`
- 修正: `app/controllers/application_controller.rb`

**検証方法**:
- 新しいヘルパーが正しくURLを生成すること
- 既存のリンクが正常に動作すること

### ステップ3: ルーティング構造の修正（明示的ロケール必須化）

**対応する懸念点**: オプショナルロケール処理の問題

**目的**: すべてのURLでロケールを必須とし、一貫性を確保

**作業内容**:
1. `config/routes.rb`を修正し、ロケールを必須パラメータに変更
2. ルートパス（`/`）から適切なロケール付きパスへのリダイレクト処理を追加
3. 404エラーハンドリングを改善

**ファイル変更**:
- 修正: `config/routes.rb`
- 修正: `app/controllers/application_controller.rb`
- 新規作成: `app/controllers/root_controller.rb`

**検証方法**:
- ロケールなしのURLが適切にリダイレクトされること
- 無効なロケールで404エラーが返されること
- 既存の機能が正常に動作すること

### ステップ4: LocaleServiceロジックの簡素化

**対応する懸念点**: 複雑な条件分岐、テスト/プロダクション環境の不整合

**目的**: ロケール決定ロジックを単純化し、環境間の一貫性を確保

**作業内容**:
1. LocaleServiceの複雑な条件分岐を簡素化
2. テスト環境とプロダクション環境で統一されたロジックに変更
3. 明確な優先順位に基づくロケール決定ルールを実装

**ファイル変更**:
- 修正: `app/services/locale_service.rb`
- 修正: `spec/services/locale_service_spec.rb`

**検証方法**:
- ロケール決定の優先順位が正しく動作すること
- テスト環境とプロダクション環境で同じ動作をすること
- エッジケースが適切に処理されること

### ステップ5: UI/UX一貫性の改善

**対応する懸念点**: 混在するURL戦略、オプショナルロケール処理の問題

**目的**: ユーザー体験の向上と一貫性の確保

**作業内容**:
1. 言語切り替えUIの改善
2. URL構造の統一
3. ブラウザの戻る/進むボタンでの適切な動作確保

**ファイル変更**:
- 修正: `app/views/shared/_language_switcher.html.erb`
- 修正: `app/controllers/locale_controller.rb`
- 修正: JavaScript関連ファイル（必要に応じて）

**検証方法**:
- 言語切り替えが正常に動作すること
- ブラウザナビゲーションが適切に機能すること
- SEO面でのURL構造が改善されること

### ステップ6: クリーンアップと最適化

**対応する懸念点**: 全般的なコード品質

**目的**: コードの保守性向上と最適化

**作業内容**:
1. 不要なコードの削除
2. パフォーマンスの最適化
3. ドキュメントの更新
4. テストカバレッジの改善

**ファイル変更**:
- 全体的なコードクリーンアップ
- 修正: `docs/LOCALE_SYSTEM.md`
- テストファイルの更新

**検証方法**:
- すべてのテストがパスすること
- パフォーマンスが改善されていること
- ドキュメントが最新の実装を反映していること

## 実行における注意点

### リスク管理
- 各ステップ後に十分なテストを実行
- 本番環境への適用前にステージング環境での検証を必須とする
- 各ステップでGitコミットを作成し、問題があった場合の復旧を容易にする

### 緊急時の対応
- 各ステップ完了後に動作確認ポイントを設ける
- 問題が発生した場合の即座のロールバック手順を準備
- 重要な変更前にはデータベースバックアップを取得

### 検証項目
- 既存機能の動作確認
- 新機能のテスト
- パフォーマンステスト
- セキュリティチェック
- ユーザビリティテスト

## タイムライン目安

- **ステップ1-2**: 2-3日（設定外部化とURL戦略準備）
- **ステップ3**: 2-3日（ルーティング変更、最も影響の大きい変更）
- **ステップ4**: 1-2日（ロジック簡素化）
- **ステップ5**: 1-2日（UI/UX改善）
- **ステップ6**: 1日（クリーンアップ）

**合計予想期間**: 7-11日

## 成功基準

1. **機能面**
   - すべての既存機能が正常に動作する
   - 新しいロケール決定ロジックが期待通りに動作する
   - URL構造が一貫している

2. **保守性面**
   - コードの複雑度が軽減されている
   - 設定変更が容易になっている
   - テストカバレッジが向上している

3. **ユーザー体験面**
   - 言語切り替えがスムーズに動作する
   - URL構造が分かりやすい
   - ブラウザナビゲーションが適切に動作する

## 備考

このリファクタリング計画は、既存の機能を維持しながら段階的に改善を行うことを重視しています。各ステップは独立して実行可能であり、問題が発生した場合は前のステップに戻ることができます。

実装中に新たな課題や改善点が発見された場合は、この計画を適宜更新してください。
