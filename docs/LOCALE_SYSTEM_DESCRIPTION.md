(NOTE: このファイルは、ロケールシステムの実装現状を GPT-4.1 に指示してまとめさせたものです)

# Annabelle ロケールシステム設計・実装ガイド

## 1. 概要
Annabelleのロケール（多言語）システムは、明示的なURLプレフィックス（例: `/ja/`, `/en/`）によるルーティングを基本とし、ユーザーやリクエストごとに最適なロケール判定・切替を行う仕組みです。
この設計により、アプリケーション全体で一貫した多言語対応と、柔軟な拡張性・保守性を実現しています。

---

## 2. ロケール設計と動作の原則

- **ロケール必須のURL設計**
  主要な画面・APIは `/ja/...` や `/en/...` のようなロケールスコープ付きURLで提供されます。
  これにより、URL自体が現在の言語状態を明示し、SEOやブックマーク、外部連携にも強い構造となります。

- **例外パスの存在**
  OAuth認証や一部の外部連携用エンドポイントなど、ロケールスコープ外で動作するパスも存在します。
  これらはルーティングで明示的に例外扱いされ、404やリダイレクトの対象外となります。

- **ルートアクセス時の自動判定**
  `/`（ルート）へのアクセス時は、LocaleUtilsのロジックにより「パラメータ → ユーザー設定 → Accept-Languageヘッダ → デフォルト」の順でロケールを決定し、該当ロケールのトップページ（例: `/ja` または `/en`）へリダイレクトします。

- **明示的なロケール切替**
  `/locale/:locale` へのアクセスで、指定ロケールが有効な場合は、`redirect_to`パラメータで指定されたパス、またはロケールトップへリダイレクトします。
  無効なロケール指定時は、ルートへリダイレクトし、アラートを表示します。

- **スコープ内での言語切替**
  ロケールスコープ内（例: `/ja/messages`）では、言語切替UIやURL操作ヘルパを通じて、現在のページのまま他言語の同一パスへ遷移できます。

- **例外パスの処理**
  OAuth認証コールバック等、特定のパスはロケールスコープ外で動作し、通常のリダイレクトや404処理の対象外となります。

---

## 3. 主要コンポーネントと責務

- **LocaleController**
  ルートアクセス時の自動リダイレクト、明示的なロケール切替（`/locale/:locale`）、不正ロケール時のエラーハンドリングを担当。

- **LocaleUtils**
  ロケール決定ロジックを提供。判定優先順位は「パラメータ → ユーザー設定 → Accept-Languageヘッダ → デフォルト」。

- **LocaleValidator**
  サポート対象ロケールかどうかのバリデーションを一元化。

- **LocaleHelper**
  パスからのロケール抽出・付与・除去、OAuth用パラメータ生成など、URL操作や補助的な処理を提供。

- **LocaleConfiguration**
  `config/locales.yml`から利用可能ロケール・デフォルトロケール・メタデータを読み込み、APIとして提供。

---

## 4. 設定ファイル（config/locales.yml）の構成と役割

Annabelleのロケール設定は `config/locales.yml` で一元管理されています。

```yaml
locales:
  default: en
  available:
    - en
    - ja
  metadata:
    en:
      name: "English"
      native_name: "English"
      direction: ltr
    ja:
      name: "Japanese"
      native_name: "日本語"
      direction: ltr
```

- **default**
  デフォルトロケール。ルートアクセス時や判定不能時に使用されます。

- **available**
  利用可能なロケールのリスト。ここに記載されたロケールのみが有効です。

- **metadata**
  各ロケールの表示名（`name`）、ネイティブ名（`native_name`）、テキスト方向（`direction`）などのメタデータ。
  これらはUI表示や言語切替UIの生成などに利用されます。
  - `direction`はテキストの表示方向（`ltr`=左→右, `rtl`=右→左）を示します。

